name: Run Automated Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: app
          MYSQL_USER: app
          MYSQL_PASSWORD: pass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      # 1. Клонируем репозиторий
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Устанавливаем Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # 3. Устанавливаем зависимости
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Устанавливаем Docker Compose
      - name: Set up Docker Compose
        run: |
          echo "Docker Compose установка не требуется — уже доступен в ubuntu-latest"

      # 5. Запускаем SUT (веб-приложение) из docker-compose.yml
      - name: Start SUT (app container only)
        run: |
          docker-compose up -d app
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/app
          SPRING_DATASOURCE_USERNAME: app
          SPRING_DATASOURCE_PASSWORD: pass

      # 6. Ждём, пока приложение станет доступно
      - name: Wait for SUT to be ready
        run: |
          for i in {1..60}; do
            curl -f http://localhost:8080 && echo "SUT is ready!" && break || sleep 5
          done
        continue-on-error: false

      # 7. Запускаем UI-тесты
      - name: Run UI tests
        run: |
          pytest Tests/test_UI.py \
            --alluredir=Reports/Allure-Results \
            --clean-alluredir \
            -v

      # 8. Запускаем тесты БД (если нужно)
      - name: Run DB tests
        run: pytest Tests/test_db.py -v

      # 9. Генерируем HTML-отчёт Allure
      - name: Generate Allure HTML Report
        run: |
          allure generate Reports/Allure-Results -o Reports/Allure-HTML --clean || echo "Allure report generation skipped"

      # 10. Сохраняем результаты
      - name: Upload Allure results (JSON)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-json
          path: Reports/Allure-Results

      - name: Upload Allure HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-html-report
          path: Reports/Allure-HTML
